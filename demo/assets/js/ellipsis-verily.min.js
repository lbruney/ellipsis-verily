/*
  A true plugin for text truncation with html support.
  https://github.com/lbruney/ellipsis-verily
  
  @autor L. Bruney <859763852@qq.com>
  @version 2.0.5
  @year 2016
 */
(function(){var t;t=function(){function t(t,s){var e;return e={min:300,delimiters:{tag:"♠",break:" ",nonEnglishBreak:"。"},handler:".js-ellipsis-handler",visible:".visible-text",truncated:".truncated-text",ellipsis:".ellipsis-text",hiddenClass:"display-none",showClass:"display-inline",activeClass:"is-open",moreText:"Read more",lessText:"Show less",parent:null,tags:["a","img","p","span","strong","em","label","br","h1","h2","h3","h4","b","code","ul","li"],selfClosingTags:["img","hr","br"]},this.ops=$.extend(e,s),this.el=$(t),this.tags=this.ops.tags,this.init(),this}return t.prototype.init=function(){return this.testIndexOf(),this.makePlaceHolderTags(),this.makeEllipsis(),this.setEvents()},t.prototype.testIndexOf=function(){if(!Array.prototype.indexOf)return Array.prototype.indexOf=function(t){var s,e;for(e=this.length>>>0,s=Number(arguments[1])||0,s=s<0?Math.ceil(s):Math.floor(s),s<0&&(s+=e);s<e;){if(s in this&&this[s]===t)return s;s++}return-1}},t.prototype.setEvents=function(){var t,s,e;e=this,this.ops.parent?(s=this.el.parentsUntil(this.ops.parent),t=s.length?s.parent():this.el.parent(),this.handler=t.find(this.ops.handler)):this.handler=$(this.ops.handler),this.handler.click(function(t){return function(s){var e;return e=$(s.currentTarget),e.toggleClass(t.ops.activeClass),e.hasClass(t.ops.activeClass)?e.text(t.ops.lessText):e.text(t.ops.moreText),t.el.find(t.ops.ellipsis).toggleClass(t.ops.hiddenClass).toggleClass(t.ops.showClass),t.el.find(t.ops.truncated).toggleClass(t.ops.hiddenClass).toggleClass(t.ops.showClass),!1}}(this))},t.prototype.stripOtherTags=function(){return this.html=this.html.replace(/(<([^>]+)>)/gi,"")},t.prototype.makePlaceHolderTags=function(){var t;for(this.html=this.el.html().replace(/%[A-F\d]{2}/g,"U"),this.openTagsHtml=[],this.closeTagsHtml=[],this.tagsHtml=[],t=0;t<this.tags.length;)this.findTags(this.tags[t]),this.isNotSelfClosingTag(this.tags[t])&&this.findTags(this.tags[t],!1),t++;this.compressHtml(this.openTagsHtml),this.compressHtml(this.closeTagsHtml),this.stripOtherTags()},t.prototype.getTag=function(t,s){return null==s&&(s=!0),s?"<"+t+"[^>]*>":"</"+t+">"},t.prototype.getPlaceholderTag=function(t,s){return null==s&&(s=!0),s?"〚"+t+"[^〛]*〛":"〚/"+t+"〛"},t.prototype.findTags=function(t,s){var e,i;if(null==s&&(s=!0),i=this.getRegex(this.getTag(t,s)),e=this.html.match(i),e&&e.length)return s?this.openTagsHtml=this.openTagsHtml.concat(e):this.closeTagsHtml=this.closeTagsHtml.concat(e)},t.prototype.compressHtml=function(t){var s,e,i,h;for(s=0,h=[];s<t.length;)e=t[s],i=this.getTagNoSpace(e),this.tagsHtml.push(i),this.html=this.html.replace(this.getRegex(e),i),h.push(s++);return h},t.prototype.makeEllipsis=function(){var t,s;if(t=this.tagsHtml.length?this.tagsHtml.toString().length+this.ops.min:this.ops.min,!(this.html.length<t))return s=this.html.match(/[\u3400-\u9FBF]/)?this.html.indexOf(this.ops.delimiters.nonEnglishBreak,t):this.html.indexOf(this.ops.delimiters.break,t),s>-1?(this.half1=this.html.substr(0,s),this.half2=this.html.substr(s,this.html.length-1),this.findBreaks(),this.recreateHtml(),this.el.html(this.finalHtml)):void 0},t.prototype.isNotSelfClosingTag=function(t){return this.ops.selfClosingTags.indexOf(t)<=-1},t.prototype.findBreaks=function(){var t,s,e,i,h,l,n,a,r,o,p;for(h=0;h<this.tags.length;){if(a=this.tags[h],this.isNotSelfClosingTag(a)&&(t=this.getPlaceholderTag(a,!1),i=this.getPlaceholderTag(a),p=this.countOccurrences(i),o=this.countOccurrences(t),p>o))for(e=p-o,s=0,r=p-1,n=this.half1.match(this.getRegex(i));s<e;)l=n[r],this.appendToTruncated(l,t),r--,s++;h++}},t.prototype.recreateHtml=function(){return this.finalHtml='<div class="'+this.ops.visible.substr(1)+'">'+this.half1+'<span class="'+this.ops.ellipsis.substr(1)+" "+this.ops.showClass+'">...</span></div><div class="'+this.ops.truncated.substr(1)+" "+this.ops.hiddenClass+'" >'+this.half2+"</div>",this.replenishTags(this.openTagsHtml),this.replenishTags(this.closeTagsHtml)},t.prototype.replenishTags=function(t){var s,e;for(s=0,e=[];s<t.length;)this.replenishTag(t[s]),e.push(s++);return e},t.prototype.replenishTag=function(t){var s;return s=this.getTagNoSpace(t),this.finalHtml=this.finalHtml.replace(this.getRegex(s),t)},t.prototype.getTagNoSpace=function(t){return t=t.replace(this.getRegex(" "),this.ops.delimiters.tag).replace(this.getRegex("<"),"{").replace(this.getRegex(">"),"}")},t.prototype.appendToTruncated=function(t,s){return this.half1=this.half1+s,this.half2=t+this.half2},t.prototype.countOccurrences=function(t){var s;return s=this.half1.match(this.getRegex(t)),s?s.length:0},t.prototype.getRegex=function(t){return new RegExp(t,"gi")},$.fn.EllipsisVerily=function(s){$(this).each(function(e,i){if(!$(this).data("ellipsis-verily"))return $(this).data("ellipsis-verily",new t(this,s))})},t}()}).call(this);